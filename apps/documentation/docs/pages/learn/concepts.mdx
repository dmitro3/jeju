# Core Concepts

Jeju uses ERC-4337 (account abstraction) for gasless transactions, ERC-8004 for agent identity, ERC-7683 for cross-chain intents, and x402 for pay-per-request APIs.

## Account Abstraction (ERC-4337)

Traditional Ethereum: EOA pays gas in ETH.
Account Abstraction: Smart contract wallets, custom gas payment.

### Key Types

```typescript
interface UserOperation {
  sender: `0x${string}`;           // Smart account address
  nonce: bigint;
  callData: `0x${string}`;         // Encoded function call
  callGasLimit: bigint;
  verificationGasLimit: bigint;
  preVerificationGas: bigint;
  maxFeePerGas: bigint;
  maxPriorityFeePerGas: bigint;
  paymasterAndData: `0x${string}`; // Paymaster address + data
  signature: `0x${string}`;
}

// Flow:
// 1. User creates UserOperation
// 2. Bundler collects UserOps
// 3. Bundler submits to EntryPoint contract
// 4. EntryPoint validates with Paymaster
// 5. Paymaster checks payment (tokens or sponsorship)
// 6. Transaction executes
// 7. Paymaster receives payment
```

### Paymaster Types

**Multi-Token Paymaster:** User pays gas in any registered token

```typescript
const paymasterData = encodePaymasterData({
  paymaster: MULTI_TOKEN_PAYMASTER,
  token: USDC_ADDRESS,
  maxTokenAmount: parseUnits('5', 6),
});

// Paymaster:
// 1. Checks user has enough USDC
// 2. Queries oracle for ETH/USDC rate
// 3. Calculates required USDC
// 4. Pulls USDC from user after execution
// 5. Uses own ETH deposit for actual gas
```

**Sponsored Paymaster:** App pays, user pays nothing

```typescript
// App creates paymaster
const paymaster = await factory.createSponsoredPaymaster(
  appWallet,
  [gameContract], // Whitelisted contracts
);
await paymaster.deposit({ value: parseEther('10') });

// All calls to gameContract are free for users
```

## Intents (ERC-7683)

Express *what* you want, not *how*.

```typescript
interface CrossChainIntent {
  id: `0x${string}`;
  creator: `0x${string}`;
  sourceChain: number;
  destinationChain: number;
  tokenIn: `0x${string}`;
  tokenOut: `0x${string}`;
  amountIn: bigint;
  minAmountOut: bigint;
  deadline: number;
  recipient: `0x${string}`;
  status: 'PENDING' | 'FILLED' | 'CANCELLED' | 'EXPIRED';
  solver?: `0x${string}`;
}

// Flow:
// 1. User creates intent on source chain (InputSettler)
// 2. Solver sees intent via Indexer
// 3. Solver fills on destination (OutputSettler)
// 4. Oracle verifies source chain deposit
// 5. Solver claims payment from InputSettler
```

### Contracts

| Contract | Chain | Purpose |
|----------|-------|---------|
| InputSettler | Source | User deposits, solver claims |
| OutputSettler | Destination | Solver fills |
| SolverRegistry | Jeju | Solver stake management |
| OracleAdapter | Both | Cross-chain verification |

## Agent Identity (ERC-8004)

On-chain registry for applications and AI agents.

```typescript
interface RegisteredAgent {
  address: `0x${string}`;
  name: string;
  description: string;
  a2aEndpoint: string;    // Agent-to-Agent protocol URL
  mcpEndpoint: string;    // Model Context Protocol URL
  metadataUri: string;    // ipfs://... extended info
  trustLabels: string[];  // ['verified', 'trusted']
  active: boolean;
  registeredAt: number;
}

// Register
await identityRegistry.register(
  'TradingBot',
  'Autonomous market maker',
  'https://mybot.com/a2a',
  'https://mybot.com/mcp',
  'ipfs://Qm...'
);

// Discover
const agent = await identityRegistry.getAgentByName('TradingBot');
// Returns: { address, name, a2aEndpoint, ... }
```

### A2A Protocol

Agent-to-agent task execution:

```typescript
interface A2ARequest {
  type: 'task';
  taskId: string;
  task: {
    skill: string;
    parameters: Record<string, unknown>;
  };
}

interface A2AResponse {
  type: 'task-result';
  taskId: string;
  status: 'completed' | 'failed' | 'pending';
  result?: unknown;
  error?: { code: string; message: string };
}

// Call another agent
const response = await fetch(agent.a2aEndpoint, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    type: 'task',
    taskId: crypto.randomUUID(),
    task: { skill: 'analyze-market', parameters: { token: 'JEJU' } },
  }),
});
const result: A2AResponse = await response.json();
```

### MCP Protocol

For AI models to interact with blockchain:

```typescript
interface MCPTool {
  name: string;
  description: string;
  inputSchema: JSONSchema;
  handler: (params: unknown) => Promise<unknown>;
}

// Example: AI can call get_balance tool
const tools: MCPTool[] = [
  {
    name: 'get_balance',
    description: 'Get token balance for address',
    inputSchema: {
      type: 'object',
      properties: {
        address: { type: 'string' },
        token: { type: 'string' },
      },
      required: ['address'],
    },
    handler: async ({ address, token }) => {
      return await getBalance(address, token);
    },
  },
];
```

## x402 Payments

HTTP payment protocol for pay-per-request APIs.

```typescript
interface PaymentRequirement {
  x402Version: 1;
  error: string;
  accepts: Array<{
    scheme: 'exact';
    network: string;
    maxAmountRequired: string;
    resource: string;
    description: string;
    payTo: `0x${string}`;
    asset: `0x${string}`;
    maxTimeoutSeconds: number;
  }>;
}

interface PaymentPayload {
  version: 1;
  network: string;
  amount: string;
  recipient: `0x${string}`;
  resource: string;
  timestamp: number;
  nonce: string;
  payer: `0x${string}`;
  signature: `0x${string}`;
}

// Flow:
// 1. Client: GET /api/premium
// 2. Server: 402 + PaymentRequirement
// 3. Client: Sign payment
// 4. Client: GET /api/premium + X-Payment header
// 5. Server: Verify, serve response, settle on-chain
```

## Cross-Chain Liquidity (EIL)

XLP = Cross-chain Liquidity Provider

```typescript
// XLP stakes on L1 (Ethereum)
await l1StakeManager.stake(stakeAmount);

// XLP provides liquidity on L2 (Jeju)
await liquidityVault.deposit(USDC, liquidityAmount);

// User wants fast bridge:
// 1. User deposits on Ethereum
// 2. XLP sees deposit, provides tokens on Jeju instantly
// 3. User has funds in seconds
// 4. XLP claims user's deposit after confirmation
// No wrapped tokens, no 7-day wait
```

## Block Timeline

```
Flashblock (200ms) → Full Block (2s) → Batch (~10min) → Settlement (~1hr) → Finality (7 days)
     ↑                    ↑                 ↑                  ↑                  ↑
  UI feedback      Safe to build      DA recoverable     Cross-chain       L1 withdrawals
```
