name: DWS CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/dws/**'
      - '.github/workflows/compute-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/dws/**'

env:
  CI: true

jobs:
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: TypeScript type check
        working-directory: apps/dws
        run: bun run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Install workerd binary
        working-directory: apps/dws
        run: bun run install:workerd

      - name: Verify workerd installation
        run: |
          WORKERD_PATH=$(cat apps/dws/node_modules/.workerd-path 2>/dev/null || echo "")
          if [ -n "$WORKERD_PATH" ] && [ -x "$WORKERD_PATH" ]; then
            echo "workerd installed at: $WORKERD_PATH"
            $WORKERD_PATH --version
          else
            echo "workerd not found, checking PATH..."
            which workerd || echo "workerd not in PATH"
          fi

      - name: Run unit tests
        working-directory: apps/dws
        run: bun test tests/workerd.test.ts || true

  integration-tests:
    name: Integration Tests (with Anvil)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Install workerd binary
        working-directory: apps/dws
        run: bun run install:workerd

      - name: Initialize contract dependencies
        working-directory: packages/contracts
        run: |
          forge install eth-infinitism/account-abstraction --no-git || true
          forge install foundry-rs/forge-std --no-git || true

      - name: Build contracts
        working-directory: packages/contracts
        run: forge build

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --port 6546 &
          sleep 3
          curl -s http://127.0.0.1:6546 -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'

      - name: Deploy test contracts
        working-directory: packages/contracts
        run: |
          forge script script/Deploy.s.sol:DeployScript --rpc-url http://127.0.0.1:6546 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

      - name: Run integration tests
        working-directory: apps/dws
        env:
          JEJU_RPC_URL: http://127.0.0.1:6546
        run: bun test tests/integration/*.test.ts || true

  workerd-tests:
    name: Workerd Runtime Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Install workerd binary
        working-directory: apps/dws
        run: bun run install:workerd

      - name: Verify workerd installation
        working-directory: apps/dws
        run: |
          WORKERD_PATH=$(cat node_modules/.workerd-path 2>/dev/null || echo "")
          if [ -n "$WORKERD_PATH" ] && [ -x "$WORKERD_PATH" ]; then
            echo "workerd installed at: $WORKERD_PATH"
            $WORKERD_PATH --version
          else
            echo "::error::workerd installation failed"
            exit 1
          fi

      - name: Run workerd tests
        working-directory: apps/dws
        run: bun test tests/workerd.test.ts

      - name: Run infrastructure tests
        working-directory: apps/dws
        run: bun test tests/infrastructure-direct.test.ts

  mcp-a2a-tests:
    name: MCP & A2A Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Install workerd binary
        working-directory: apps/dws
        run: bun run install:workerd

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --port 6546 &
          sleep 3

      - name: Run A2A and MCP tests
        working-directory: apps/dws
        env:
          JEJU_RPC_URL: http://127.0.0.1:6546
        run: bun test tests/a2a*.test.ts tests/mcp*.test.ts || true
