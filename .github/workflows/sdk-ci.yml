name: SDK CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/sdk/**'
      - 'packages/types/**'
      - 'packages/config/**'
      - '.github/workflows/sdk-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/sdk/**'
      - 'packages/types/**'
      - 'packages/config/**'
      - '.github/workflows/sdk-ci.yml'

jobs:
  test:
    name: Test SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build dependencies
        run: cd packages/types && bun run build

      - name: Type check
        run: cd packages/sdk && bun run typecheck

      - name: Run unit tests
        run: cd packages/sdk && bun test test/*.test.ts

      - name: Run e2e tests (mock)
        run: cd packages/sdk && bun test test/e2e/*.test.ts

      - name: Build SDK
        run: cd packages/sdk && bun run build

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Lint
        run: cd packages/sdk && bun run lint || true

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build dependencies
        run: cd packages/types && bun run build

      - name: Run tests with coverage
        run: cd packages/sdk && bun test --coverage test/*.test.ts

  publish-dry-run:
    name: Publish Dry Run
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node (for npm)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Build dependencies
        run: cd packages/types && bun run build

      - name: Build SDK
        run: cd packages/sdk && bun run build

      - name: Pack (dry run)
        run: cd packages/sdk && npm pack --dry-run

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test]
    services:
      anvil:
        image: ghcr.io/foundry-rs/foundry:latest
        options: >-
          --entrypoint anvil
        ports:
          - 8545:8545
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Build all dependencies
        run: |
          cd packages/types && bun run build
          cd ../contracts && forge build && bun run build

      - name: Run integration tests
        run: cd packages/sdk && JEJU_NETWORK=localnet bun test test/integration/*.test.ts
        continue-on-error: true

