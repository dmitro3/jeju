name: E2E Wallet Tests (Synpress)

# Run E2E wallet tests using Synpress + MetaMask
# These tests verify wallet connection, transactions, and on-chain state

on:
  push:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/tests/**"
      - "packages/contracts/**"
      - ".github/workflows/e2e-synpress.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/tests/**"
      - "packages/contracts/**"
  workflow_dispatch:
    inputs:
      app:
        description: 'Specific app to test (leave empty for all)'
        required: false
        type: string

concurrency:
  group: e2e-synpress-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  CHAIN_ID: "31337"
  L2_RPC_URL: "http://127.0.0.1:6546"
  JEJU_RPC_URL: "http://127.0.0.1:6546"

jobs:
  # ============================================================================
  # PREFLIGHT - Ensure environment is ready
  # ============================================================================
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    outputs:
      apps-to-test: ${{ steps.discover.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Discover testable apps
        id: discover
        run: |
          if [ -n "${{ inputs.app }}" ]; then
            echo "apps=[\"${{ inputs.app }}\"]" >> $GITHUB_OUTPUT
          else
            # Default apps that have synpress tests
            echo 'apps=["gateway", "wallet", "bazaar", "crucible"]' >> $GITHUB_OUTPUT
          fi

      - name: Print discovered apps
        run: echo "Apps to test - ${{ steps.discover.outputs.apps }}"

  # ============================================================================
  # BUILD SYNPRESS CACHE
  # ============================================================================
  build-synpress-cache:
    name: Build Synpress Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install chromium --with-deps

  # ============================================================================
  # CHAIN SMOKE TEST - Quick validation that chain works
  # ============================================================================
  chain-smoke:
    name: Chain Smoke Test
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 31337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5
          RESULT=$(curl -s -X POST http://127.0.0.1:6546 \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}')
          echo "Chain response: $RESULT"
          echo "$RESULT" | grep -q "0x7a69" && echo "Chain is ready"

  # ============================================================================
  # E2E TESTS - Run per app
  # ============================================================================
  e2e-gateway:
    name: E2E - Gateway
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'gateway') || github.event.inputs.app == 'gateway' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers (if cache miss)
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 31337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Start Gateway
        run: |
          cd apps/gateway
          bun run dev &
          sleep 15
        env:
          L2_RPC_URL: http://127.0.0.1:6546

      - name: Run E2E tests
        working-directory: apps/gateway
        run: bunx playwright test tests/e2e/ --config playwright.config.ts || true
        env:
          GATEWAY_URL: http://localhost:4001

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-gateway-results
          path: |
            apps/gateway/test-results/
            apps/gateway/playwright-report/
          retention-days: 7

  e2e-wallet:
    name: E2E - Wallet
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'wallet') || github.event.inputs.app == 'wallet' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers (if cache miss)
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 31337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Build and start Wallet app
        run: |
          cd apps/wallet
          bun run build || true
          bun run preview &
          sleep 10
        continue-on-error: true

      - name: Run E2E tests
        working-directory: apps/wallet
        run: bunx playwright test tests/e2e/ --config playwright.config.ts || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-wallet-results
          path: |
            apps/wallet/test-results/
            apps/wallet/playwright-report/
          retention-days: 7

  # ============================================================================
  # SUMMARY
  # ============================================================================
  e2e-summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-gateway, e2e-wallet]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "E2E TEST SUMMARY"
          echo "================"
          echo "Gateway:  ${{ needs.e2e-gateway.result }}"
          echo "Wallet:   ${{ needs.e2e-wallet.result }}"
          echo ""
          echo "E2E tests completed"
