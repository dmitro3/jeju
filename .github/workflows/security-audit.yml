name: Security Audit

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup Node for npm audit
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate package-lock.json for audit
        run: npm i --package-lock-only --ignore-scripts 2>/dev/null || true

      - name: Run security audit (high severity)
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high 2>&1 | tee audit-results.txt || true
          
          # Check if there are vulnerabilities
          if grep -q "found 0 vulnerabilities" audit-results.txt; then
            echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Audit completed - check report for details" >> $GITHUB_STEP_SUMMARY
          fi

  smart-contract-security:
    name: Smart Contract Security (Slither)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts first
        run: cd packages/contracts && forge build

      - name: Run Slither on core contracts
        uses: crytic/slither-action@v0.4.0
        continue-on-error: true
        with:
          target: 'packages/contracts/src'
          slither-args: '--filter-paths "packages/contracts/lib" --exclude naming-convention,external-function,solc-version'
          fail-on: high

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for hardcoded secrets
        run: |
          # Look for private keys in non-test files (64 hex chars after 0x that look like private keys)
          # Exclude: test files, example files, mock data, well-known addresses
          FOUND=0
          
          # Check for common private key patterns in source files
          if grep -rE "privateKey.*=.*['\"]0x[a-fA-F0-9]{64}['\"]" \
            --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=test --exclude-dir=tests \
            --exclude="*.test.ts" --exclude="*.spec.ts" --exclude="*mock*" \
            . 2>/dev/null; then
            echo "Found potential hardcoded private key"
            FOUND=1
          fi
          
          # Check for AWS keys
          if grep -rE "AKIA[0-9A-Z]{16}" \
            --include="*.ts" --include="*.js" --include="*.json" --include="*.env*" \
            --exclude-dir=node_modules --exclude-dir=.git \
            . 2>/dev/null; then
            echo "Found potential AWS key"
            FOUND=1
          fi
          
          if [ "$FOUND" -eq 1 ]; then
            echo "Review the above findings for potential secrets"
            exit 1
          fi

          echo "No hardcoded secrets detected"
