name: Security Audit

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Setup Node for npm audit
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate package-lock.json for audit
        run: npm i --package-lock-only --ignore-scripts 2>/dev/null || true

      - name: Run security audit (high severity)
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high 2>&1 | tee audit-results.txt || true
          
          # Check if there are vulnerabilities
          if grep -q "found 0 vulnerabilities" audit-results.txt; then
            echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Audit completed - check report for details" >> $GITHUB_STEP_SUMMARY
          fi

  smart-contract-security:
    name: Smart Contract Security (Slither)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Initialize submodules
        run: git submodule update --init --recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install contract dependencies
        working-directory: packages/contracts
        run: |
          forge install foundry-rs/forge-std --no-git || true
          forge install OpenZeppelin/openzeppelin-contracts@v5.3.0 --no-git || true
          forge install eth-infinitism/account-abstraction --no-git || true

      - name: Build contracts
        run: cd packages/contracts && forge build
        continue-on-error: true

      - name: Check build status
        run: |
          if [ -d "packages/contracts/out" ]; then
            echo "Build successful"
          else
            echo "Build failed, but continuing for Slither analysis"
          fi

      - name: Run Slither on core contracts
        uses: crytic/slither-action@v0.4.0
        continue-on-error: true
        with:
          target: 'packages/contracts/src'
          slither-args: '--filter-paths "packages/contracts/lib" --exclude naming-convention,external-function,solc-version'
          fail-on: high

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for hardcoded secrets
        run: |
          # Look for private keys in non-test files (64 hex chars after 0x that look like private keys)
          # Exclude: test files, example files, mock data, well-known addresses, scripts
          FOUND=0
          
          # Well-known test private keys to exclude (Anvil default keys)
          KNOWN_TEST_KEYS=(
            "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
            "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
            "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
          )
          
          # Check for common private key patterns in source files (exclude build artifacts)
          MATCHES=$(grep -rE "privateKey.*=.*['\"]0x[a-fA-F0-9]{64}['\"]" \
            --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=test --exclude-dir=tests \
            --exclude-dir=scripts --exclude-dir=packages/deployment --exclude-dir=dist \
            --exclude-dir=.cache-synpress --exclude-dir=dist-ext-firefox --exclude-dir=dist-ext-chrome \
            --exclude-dir=.dws-bundle --exclude-dir=lib --exclude-dir=build \
            --exclude="*.test.ts" --exclude="*.spec.ts" --exclude="*mock*" --exclude="*example*" \
            . 2>/dev/null || true)
          
          # Filter out known test keys
          for key in "${KNOWN_TEST_KEYS[@]}"; do
            MATCHES=$(echo "$MATCHES" | grep -v "$key" || true)
          done
          
          if [ -n "$MATCHES" ]; then
            echo "Found potential hardcoded private key:"
            echo "$MATCHES"
            FOUND=1
          fi
          
          # Check for AWS keys (exclude test files and well-known example keys)
          AWS_MATCHES=$(grep -rE "AKIA[0-9A-Z]{16}" \
            --include="*.ts" --include="*.js" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=test --exclude-dir=tests \
            --exclude="*.test.ts" --exclude="*.spec.ts" --exclude="*mock*" \
            . 2>/dev/null | grep -v "AKIAIOSFODNN7EXAMPLE" || true)
          
          if [ -n "$AWS_MATCHES" ]; then
            echo "Found potential AWS key:"
            echo "$AWS_MATCHES"
            FOUND=1
          fi
          
          if [ "$FOUND" -eq 1 ]; then
            echo "Review the above findings for potential secrets"
            exit 1
          fi

          echo "No hardcoded secrets detected"
