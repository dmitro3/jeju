name: Mirror to JejuGit

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to mirror'
        required: false
        default: 'main'

jobs:
  mirror-to-jejugit:
    runs-on: ubuntu-latest
    env:
      JEJUGIT_URL: ${{ secrets.JEJUGIT_URL }}
      JEJUGIT_TOKEN: ${{ secrets.JEJUGIT_TOKEN }}
    steps:
      - name: Check configuration
        id: check
        run: |
          if [ -z "$JEJUGIT_URL" ]; then
            echo "JejuGit URL not configured, skipping mirror."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Configure JejuGit remote
        if: steps.check.outputs.skip != 'true'
        run: |
          git remote add jejugit "$JEJUGIT_URL/jeju/jeju.git" || git remote set-url jejugit "$JEJUGIT_URL/jeju/jeju.git"
          git config --global credential.helper store
          JEJUGIT_HOST="${JEJUGIT_URL#https://}"
          echo "https://$JEJUGIT_TOKEN:x-oauth-basic@$JEJUGIT_HOST" > ~/.git-credentials

      - name: Push to JejuGit
        if: steps.check.outputs.skip != 'true'
        run: |
          BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
          echo "Mirroring branch: $BRANCH"
          git push jejugit "$BRANCH:$BRANCH" --force
          git push jejugit --tags --force || true

      - name: Update JejuGit repository metadata
        if: steps.check.outputs.skip != 'true' && success()
        run: |
          curl -X POST "$JEJUGIT_URL/api/v1/repos/jeju/jeju/sync" \
            -H "Authorization: Bearer $JEJUGIT_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"source": "github", "sourceUrl": "${{ github.server_url }}/${{ github.repository }}"}'
