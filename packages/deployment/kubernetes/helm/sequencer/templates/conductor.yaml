{{- if .Values.multiSequencer.conductor.enabled }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "sequencer.fullname" . }}-conductor
  labels:
    {{- include "sequencer.labels" . | nindent 4 }}
    component: conductor
spec:
  serviceName: {{ include "sequencer.fullname" . }}-conductor-headless
  replicas: {{ .Values.replicaCount }}
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      {{- include "sequencer.selectorLabels" . | nindent 6 }}
      component: conductor
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9000"
      labels:
        {{- include "sequencer.selectorLabels" . | nindent 8 }}
        component: conductor
    spec:
      containers:
        - name: conductor
          image: "{{ .Values.multiSequencer.conductor.image.repository }}:{{ .Values.multiSequencer.conductor.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          args:
            - op-conductor
            - --rpc.addr=0.0.0.0
            - --rpc.port=9000
            - --node.rpc=http://{{ include "sequencer.fullname" . }}-$(POD_INDEX):9545
            - --health-check.interval={{ .Values.multiSequencer.conductor.healthCheck.interval }}
            - --health-check.safety-margin={{ .Values.multiSequencer.conductor.healthCheck.safetyMargin }}
            - --health-check.min-peer-count={{ .Values.multiSequencer.conductor.healthCheck.minPeerCount }}
            - --raft.server-id=$(POD_NAME)
            - --raft.storage.dir=/data/raft
            # Raft cluster members
            {{- range $i := until (int .Values.replicaCount) }}
            - --raft.bootstrap.peers={{ include "sequencer.fullname" $ }}-conductor-{{ $i }}=http://{{ include "sequencer.fullname" $ }}-conductor-{{ $i }}.{{ include "sequencer.fullname" $ }}-conductor-headless:9000
            {{- end }}
          ports:
            - name: rpc
              containerPort: 9000
              protocol: TCP
            - name: raft
              containerPort: 9100
              protocol: TCP
          volumeMounts:
            - name: data
              mountPath: /data
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_INDEX
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['apps.kubernetes.io/pod-index']
          resources:
            {{- toYaml .Values.resources.conductor | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /healthz
              port: rpc
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: rpc
            initialDelaySeconds: 5
            periodSeconds: 5
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: {{ .Values.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.persistence.conductor.size }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "sequencer.fullname" . }}-conductor
  labels:
    {{- include "sequencer.labels" . | nindent 4 }}
    component: conductor
spec:
  type: ClusterIP
  ports:
    - port: 9000
      targetPort: rpc
      protocol: TCP
      name: rpc
    - port: 9100
      targetPort: raft
      protocol: TCP
      name: raft
  selector:
    {{- include "sequencer.selectorLabels" . | nindent 4 }}
    component: conductor
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "sequencer.fullname" . }}-conductor-headless
  labels:
    {{- include "sequencer.labels" . | nindent 4 }}
    component: conductor
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 9000
      targetPort: rpc
      protocol: TCP
      name: rpc
    - port: 9100
      targetPort: raft
      protocol: TCP
      name: raft
  selector:
    {{- include "sequencer.selectorLabels" . | nindent 4 }}
    component: conductor
{{- end }}

