# Default values for Jeju Compute Services
# Supports workerd-based serverless execution with scale-to-zero

global:
  imageRegistry: ""
  imagePullSecrets: []

# Common settings
common:
  rpcUrl: ""
  registryAddress: ""
  workerRegistryAddress: ""
  ledgerAddress: ""
  inferenceAddress: ""

# Compute Node - AI inference + GPU rentals
computeNode:
  enabled: true
  replicaCount: 2
  
  image:
    repository: jeju/compute
    # SECURITY: Always specify a version tag, never use 'latest' in production
    tag: "v1.0.0"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 4007
  
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"
  
  env:
    SERVICE: node
    COMPUTE_PORT: "4007"
  
  # GPU support (for TEE nodes)
  gpu:
    enabled: false
    count: 1
    type: nvidia-tesla-t4
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# Worker Runtime - Serverless JavaScript execution (workerd-based)
workerRuntime:
  enabled: true
  replicaCount: 3
  
  image:
    repository: jeju/compute
    # SECURITY: Always specify a version tag, never use 'latest' in production
    tag: "v1.0.0"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 4020
  
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  
  env:
    SERVICE: workers
    WORKER_SERVER_PORT: "4020"
  
  # Standard HPA autoscaling
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
  
  # KEDA-based autoscaling with scale-to-zero
  keda:
    enabled: false
    minReplicaCount: 0
    maxReplicaCount: 50
    cooldownPeriod: 300
    pollingInterval: 15
    triggers:
      - type: prometheus
        metadata:
          serverAddress: http://prometheus-server.monitoring.svc.cluster.local
          metricName: worker_active_requests
          query: sum(worker_active_requests{job="worker-runtime"})
          threshold: "5"
      - type: cpu
        metricType: Utilization
        metadata:
          value: "70"
  
  # Regional deployment
  regional:
    enabled: false
    regions:
      us-east-1:
        enabled: true
        minReplicas: 0
        maxReplicas: 20
        scaleToZero: true
        idleTimeoutSeconds: 300
      eu-west-1:
        enabled: true
        minReplicas: 0
        maxReplicas: 15
        scaleToZero: true
        idleTimeoutSeconds: 300
      ap-northeast-1:
        enabled: true
        minReplicas: 0
        maxReplicas: 15
        scaleToZero: true
        idleTimeoutSeconds: 300
  
  # Warm pool for reduced cold starts
  warmPool:
    enabled: true
    size: 3
    maxIdleTimeSeconds: 300
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# MPC Node - Threshold signing
mpcNode:
  enabled: true
  replicaCount: 3  # Minimum for 2-of-3 threshold
  
  image:
    repository: jeju/compute
    # SECURITY: Always specify a version tag, never use 'latest' in production
    tag: "v1.0.0"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 4010
  
  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "512Mi"
  
  env:
    SERVICE: mpc
    MPC_PORT: "4010"
    MPC_THRESHOLD: "2"
    MPC_TOTAL_SHARES: "3"
  
  nodeSelector: {}
  tolerations: []
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: mpc
            topologyKey: kubernetes.io/hostname

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: compute.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
          service: computeNode
        - path: /workers
          pathType: Prefix
          service: workerRuntime
        - path: /mpc
          pathType: Prefix
          service: mpcNode
  tls:
    - secretName: compute-tls
      hosts:
        - compute.jejunetwork.org

# Service account
serviceAccount:
  create: true
  name: ""
  annotations: {}

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1
