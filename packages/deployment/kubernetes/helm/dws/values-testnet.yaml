# Testnet-specific values for DWS
#
# DECENTRALIZED ARCHITECTURE:
# - All app routing is dynamic via JNS contract resolution
# - Apps register their contenthash on-chain (e.g., factory.jeju -> QmXxx)
# - DWS app-router resolves appname.testnet.jejunetwork.org via JNS
# - No static app definitions needed in this file
#
# Only infrastructure subdomains are defined here (dws, storage, git, etc.)
# Application subdomains are handled dynamically by the app-router.
#
# DECENTRALIZATION STATUS:
# - [DONE] App routing via JNS (on-chain)
# - [DONE] Storage via IPFS
# - [DONE] Database via SQLit + DWS-provisioned PostgreSQL
# - [DONE] Image registry: DWS OCI registry (proxies Docker Hub, caches in IPFS)
# - [DONE] Ingress: nginx with cert-manager
# - [TODO] DNS: Route53 -> JNS DNS mirroring (in progress)

replicaCount: 3

# IMAGE REGISTRY - Decentralized via DWS OCI Registry
# DWS hosts its own OCI-compatible registry that:
# 1. Resolves images from on-chain ContainerRegistry contract
# 2. Falls back to Docker Hub proxy for standard images
# 3. Caches all layers in IPFS
image:
  repository: registry.jeju/jeju/dws
  tag: "testnet-latest"
  pullPolicy: Always

imagePullSecrets: []

# INGRESS - Decentralized using nginx + cert-manager
# Uses Let's Encrypt for TLS certificates (not AWS ACM)
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    # Core DWS infrastructure - these are NOT apps, they are system services
    - host: dws.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: storage.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: git.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: npm.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: hub.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: registry.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    - host: jns.testnet.jejunetwork.org
      paths:
        - path: /
          pathType: Prefix
    # OCI Registry endpoint for docker pull
    - host: registry.jeju
      paths:
        - path: /v2
          pathType: Prefix
    # Wildcard - ALL other subdomains route to DWS app-router
    # The app-router resolves apps dynamically via JNS contract
    - host: "*.testnet.jejunetwork.org"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: dws-tls
      hosts:
        - dws.testnet.jejunetwork.org
        - storage.testnet.jejunetwork.org
        - git.testnet.jejunetwork.org
        - npm.testnet.jejunetwork.org
        - hub.testnet.jejunetwork.org
        - registry.testnet.jejunetwork.org
        - jns.testnet.jejunetwork.org
        - "*.testnet.jejunetwork.org"

resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

config:
  network: testnet
  chainId: 420690
  rpcUrl: "https://testnet-rpc.jejunetwork.org"
  
  # Contract addresses - populated after deployment
  contracts:
    identityRegistry: "${IDENTITY_REGISTRY_ADDRESS}"
    repoRegistry: "${REPO_REGISTRY_ADDRESS}"
    packageRegistry: "${PACKAGE_REGISTRY_ADDRESS}"
    containerRegistry: "${CONTAINER_REGISTRY_ADDRESS}"
    modelRegistry: "${MODEL_REGISTRY_ADDRESS}"
    jnsRegistry: "${JNS_REGISTRY_ADDRESS}"
    jnsResolver: "${JNS_RESOLVER_ADDRESS}"
    storageManager: "${STORAGE_MANAGER_ADDRESS}"
  
  storage:
    primary: ipfs
    permanent: true
    backends:
      - type: ipfs
        enabled: true
        gateway: "https://ipfs.io"
        apiUrl: "http://ipfs.dws.svc.cluster.local:5001"
        pinningService: "internal"
      - type: arweave
        enabled: true
        gateway: "https://arweave.net"
      - type: webtorrent
        enabled: true
  
  # Database - uses DWS-provisioned PostgreSQL for Subsquid indexer
  # PostgreSQL image pulled through DWS OCI registry
  database:
    postgres:
      enabled: true
      image: "registry.jeju/library/postgres:16-alpine"
    sqlit:
      enabled: true
  
  # JNS Gateway - serves apps at jns.testnet.jejunetwork.org
  jnsGateway:
    enabled: true
    domain: "jns.testnet.jejunetwork.org"
    defaultTtl: 300
    cacheEnabled: true
    fallbackToIpfs: true
  
  # App Router - handles *.testnet.jejunetwork.org routing
  # Routes frontend to IPFS and backend to DWS workers
  appRouter:
    enabled: true
    domain: "testnet.jejunetwork.org"
    wildcardDomain: "*.testnet.jejunetwork.org"
    # System subdomains that should NOT be routed as apps
    systemSubdomains:
      - dws
      - api
      - rpc
      - ws
      - explorer
      - bridge
      - faucet
      - docs
      - storage
      - git
      - npm
      - hub
      - registry
      - jns
    # Default API paths to route to backend
    defaultApiPaths:
      - /api
      - /health
      - /a2a
      - /mcp
      - /oauth
      - /callback
      - /webhook
  
  cdn:
    enabled: true
    edgeNodes: 3
    regions:
      - us-east-1
      - eu-west-1
      - ap-northeast-1
  
  p2p:
    enabled: true
    bootstrapPeers:
      - "/dns4/dws-0.testnet.jejunetwork.org/tcp/4031"
      - "/dns4/dws-1.testnet.jejunetwork.org/tcp/4031"
      - "/dns4/dws-2.testnet.jejunetwork.org/tcp/4031"

env:
  - name: NODE_ENV
    value: "development"  # Use development for testnet to bypass strict production security checks
  # Enable P2P for decentralized node discovery
  - name: DWS_P2P_ENABLED
    value: "true"
  # Enable provider mode - this node participates in the provider network
  - name: DWS_PROVIDER_ENABLED
    value: "true"
  - name: DWS_PORT
    value: "4030"
  - name: LOG_LEVEL
    value: "info"
  - name: NETWORK
    value: "testnet"
  - name: DWS_BASE_URL
    value: "https://dws.testnet.jejunetwork.org"
  - name: JNS_GATEWAY_ENABLED
    value: "true"
  - name: JNS_GATEWAY_DOMAIN
    value: "jns.testnet.jejunetwork.org"
  # OCI Registry - DWS serves as Docker registry at registry.jeju
  - name: DWS_OCI_REGISTRY_ENABLED
    value: "true"
  - name: DWS_REGISTRY_URL
    value: "https://registry.testnet.jejunetwork.org"
  # SQLit connection for decentralized database
  - name: SQLIT_ENABLED
    value: "true"
  # Use sqlit-adapter service for HTTP API
  - name: SQLIT_HTTP_URL
    value: "http://sqlit-adapter.dws.svc.cluster.local:8546"
  - name: SQLIT_BLOCK_PRODUCER_ENDPOINT
    value: "http://sqlit-adapter.dws.svc.cluster.local:8546"
  # Native SQLit RPC connection
  - name: SQLIT_CLUSTER_URL
    value: "sqlit.dws.svc.cluster.local:4661"
  # IPFS connection for storage and OCI registry
  - name: IPFS_API_URL
    value: "http://ipfs.dws.svc.cluster.local:5001"
  - name: IPFS_GATEWAY_URL
    value: "http://ipfs.dws.svc.cluster.local:8080"

# Secrets - use Kubernetes secrets, NOT environment variables
secretEnv:
  - name: SQLIT_PRIVATE_KEY
    secretName: dws-sqlit-credentials
    secretKey: private-key

persistence:
  # Disabled - DWS uses SQLit + ConfigMap for state (allows HA with 3 replicas)
  enabled: false

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70

metrics:
  enabled: true
  serviceMonitor:
    enabled: true

# SQLit sidecar for distributed database
sqlit:
  enabled: true
  image: registry.jeju/jeju/sqlit:latest
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 250m
      memory: 512Mi

# IPFS sidecar for decentralized storage
ipfs:
  enabled: true
  image: registry.jeju/library/kubo:v0.24.0
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi
