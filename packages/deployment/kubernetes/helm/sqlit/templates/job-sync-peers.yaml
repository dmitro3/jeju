{{- if .Values.registry.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "sqlit.fullname" . }}-sync-peers
  labels:
    {{- include "sqlit.labels" . | nindent 4 }}
  annotations:
    # Run before main deployment
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "sqlit.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: peer-sync
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "sqlit.serviceAccountName" . }}
      containers:
        - name: sync-peers
          image: curlimages/curl:latest
          env:
            - name: REGISTRY_ADDRESS
              value: "{{ .Values.registry.address }}"
            - name: RPC_URL
              value: "{{ .Values.registry.rpcUrl }}"
            - name: NAMESPACE
              value: "{{ .Release.Namespace }}"
            - name: CONFIGMAP_NAME
              value: "{{ include "sqlit.fullname" . }}-peers"
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              echo "=== SQLit Peer Sync ==="
              echo "Registry: $REGISTRY_ADDRESS"
              echo "RPC: $RPC_URL"

              # Query getActiveBlockProducers()
              # Function selector for getActiveBlockProducers()
              SELECTOR="0x3c86c41a"

              echo "Querying registry..."
              RESPONSE=$(curl -s -X POST "$RPC_URL" \
                -H "Content-Type: application/json" \
                -d "{\"jsonrpc\":\"2.0\",\"method\":\"eth_call\",\"params\":[{\"to\":\"$REGISTRY_ADDRESS\",\"data\":\"$SELECTOR\"},\"latest\"],\"id\":1}")

              RESULT=$(echo "$RESPONSE" | grep -o '"result":"[^"]*"' | cut -d'"' -f4)

              if [ -z "$RESULT" ] || [ "$RESULT" = "0x" ]; then
                echo "No peers registered yet or query failed"
                echo "Response: $RESPONSE"
                # Create empty ConfigMap
                cat > /tmp/peers.yaml << EOF
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: $CONFIGMAP_NAME
                namespace: $NAMESPACE
              data:
                peers.yaml: |
                  # No peers registered in on-chain registry
                  peers: []
              EOF
              else
                echo "Peers found in registry"
                # Parse the ABI-encoded response
                # For now, create a placeholder - actual parsing needs the sqlit-identity service
                cat > /tmp/peers.yaml << EOF
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: $CONFIGMAP_NAME
                namespace: $NAMESPACE
              data:
                peers.yaml: |
                  # Peers discovered from on-chain registry at $(date -u +"%Y-%m-%dT%H:%M:%SZ")
                  # Registry: $REGISTRY_ADDRESS
                  peers:
                    - note: "Use sqlit-identity service for full ABI decoding"
              EOF
              fi

              echo "Peer sync complete"
              cat /tmp/peers.yaml
---
# RBAC for the sync job to create/update ConfigMaps
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "sqlit.fullname" . }}-peer-sync
  labels:
    {{- include "sqlit.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "sqlit.fullname" . }}-peer-sync
  labels:
    {{- include "sqlit.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "sqlit.fullname" . }}-peer-sync
subjects:
  - kind: ServiceAccount
    name: {{ include "sqlit.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
