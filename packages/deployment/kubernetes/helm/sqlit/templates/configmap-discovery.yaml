{{- if .Values.registry.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sqlit.fullname" . }}-discovery
  labels:
    {{- include "sqlit.labels" . | nindent 4 }}
data:
  # Script to discover peers from on-chain SQLitIdentityRegistry
  discover-peers.sh: |
    #!/bin/sh
    set -e

    REGISTRY_ADDRESS="{{ .Values.registry.address }}"
    RPC_URL="{{ .Values.registry.rpcUrl }}"
    OUTPUT_FILE="/config/known-nodes.yaml"

    echo "Discovering peers from on-chain registry..."
    echo "Registry: $REGISTRY_ADDRESS"
    echo "RPC: $RPC_URL"

    # getActiveBlockProducers() returns (bytes32[], string[], bytes[], tuple[])
    # Function selector: 0x4c2d8b3a (first 4 bytes of keccak256("getActiveBlockProducers()"))
    SELECTOR="0x4c2d8b3a"

    # Make eth_call to registry
    RESPONSE=$(curl -s -X POST "$RPC_URL" \
      -H "Content-Type: application/json" \
      -d "{\"jsonrpc\":\"2.0\",\"method\":\"eth_call\",\"params\":[{\"to\":\"$REGISTRY_ADDRESS\",\"data\":\"$SELECTOR\"},\"latest\"],\"id\":1}")

    RESULT=$(echo "$RESPONSE" | jq -r '.result')

    if [ "$RESULT" = "null" ] || [ -z "$RESULT" ]; then
      echo "ERROR: Failed to query registry"
      echo "Response: $RESPONSE"
      exit 1
    fi

    echo "Raw response received (${#RESULT} chars)"

    # Parse the ABI-encoded response using a simple approach
    # The response is ABI-encoded with dynamic arrays
    # For production, use a proper ABI decoder

    # Write placeholder - actual parsing requires more complex logic
    # In production, use the sqlit-identity service for parsing
    cat > "$OUTPUT_FILE" << 'NODES'
    # Peers discovered from on-chain registry
    # This file is generated by discover-peers.sh
    KnownNodes: []
    NODES

    echo "Discovery complete. Output written to $OUTPUT_FILE"

  # Script to verify node identity against registry
  verify-identity.sh: |
    #!/bin/sh
    set -e

    NODE_ID="$1"
    PUBLIC_KEY="$2"
    NONCE_A="$3"
    NONCE_B="$4"
    NONCE_C="$5"
    NONCE_D="$6"

    REGISTRY_ADDRESS="{{ .Values.registry.address }}"
    RPC_URL="{{ .Values.registry.rpcUrl }}"

    echo "Verifying identity on-chain..."
    echo "Node ID: $NODE_ID"

    # verifyIdentity(bytes,tuple,bytes32) selector
    # This is simplified - actual implementation would encode the call properly

    echo "Identity verification placeholder - use sqlit-identity service for production"
{{- end }}
