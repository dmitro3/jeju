# SQLit Testnet Configuration
# Decentralized SQL Database for DWS

# Single-node mode for stability - multi-node requires pre-generated keys
replicaCount: 1

image:
  # Use the ECR SQLit image for testnet
  repository: 502713364895.dkr.ecr.us-east-1.amazonaws.com/jeju/sqlit
  pullPolicy: Always
  tag: "testnet-latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "4665"
  prometheus.io/path: "/metrics"

podSecurityContext:
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: false  # SQLit binary may need root for some operations
  runAsUser: 0

service:
  type: ClusterIP
  # Client connections port (native SQLit protocol)
  port: 4661
  # Metric port
  metricsPort: 4665
  # HTTP API port (for fullnode)
  httpPort: 8546
  annotations: {}

# Headless service for peer discovery
headlessService:
  enabled: true

# SQLit Native Configuration (matches docker-compose.yml)
config:
  # Cluster configuration for consensus
  cluster:
    minNodes: 2
    replicationFactor: 3
    consensusProtocol: "dpos"  # SQLit uses DPoS consensus
    electionTimeout: "5s"
    heartbeatInterval: "500ms"

  # Database configuration
  database:
    maxDatabases: 100
    walMode: true
    checkpointInterval: "30s"
    pageSize: 4096
    cacheSize: 10000
    journalMode: "WAL"

  # Network configuration (SQLit native ports)
  network:
    # Client RPC port (sqlchain protocol)
    clientPort: 4661
    # P2P port for peer coordination
    p2pPort: 4662
    # Metric port
    metricsPort: 4665
    # HTTP API port (fullnode only)
    httpPort: 8546
    tlsEnabled: false  # Enable later with cert-manager

  # Storage configuration
  storage:
    dataDir: "/data/sqlit"
    walDir: "/data/sqlit/wal"
    snapshotDir: "/data/sqlit/snapshots"
    snapshotInterval: "1h"
    maxSnapshots: 5

  # Backup configuration
  backup:
    enabled: true
    ipfsEnabled: true
    interval: "6h"
    retention: "7d"

  # Blockchain integration (for DWS registration)
  blockchain:
    rpcUrl: "https://rpc.testnet.jejunetwork.org"
    chainId: 420690
    registerAsProvider: false  # Manual registration for now

# Environment variables (SQLit native config)
env:
  - name: SQLIT_LOG_LEVEL
    value: "info"
  - name: SQLIT_CLUSTER_NAME
    value: "jeju-testnet"

# Secrets (not needed with UseTestMasterKey: true)
secretEnv: []

# Persistence
persistence:
  enabled: true
  # Use gp3 for testnet (AWS managed)
  storageClass: "gp3"
  size: 50Gi
  accessModes:
    - ReadWriteOnce

# Resources
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Liveness probe (TCP check on client port)
livenessProbe:
  tcpSocket:
    port: 4661
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe (TCP check on client port)
readinessProbe:
  tcpSocket:
    port: 4661
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity - spread across nodes
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - sqlit
        topologyKey: kubernetes.io/hostname

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s

# Network policies
networkPolicy:
  enabled: true
  allowedNamespaces:
    - dws
    - monitoring

# Init containers
initContainers: []

# Sidecar containers
sidecars: []

# Cluster node identities (verified with CovenantSQL THashH algorithm)
# Algorithm: NodeID = reverse(sha256(blake2b-512(publicKey || nonce)))
# Nonce: 4x uint64 big-endian (A, B, C, D sequential)
# NOTE: These are the ACTUAL keys generated by sqlit-0 on first startup
clusterNodes:
  - name: sqlit-0
    nodeId: "00000024e0ddd9ed2136def8dfc981dd9471de3ad987732bd43ca61ecec54db9"
    publicKey: "02aa56b3bac77b891d181367f73392fdf7db819dc37473abce17ce88a23a31d120"
    nonceA: "1856657"
    nonceB: "0"
    nonceC: "0"
    nonceD: "1736386126"
    role: "Leader"

# HTTP Adapter for DWS integration
adapter:
  enabled: true
  replicaCount: 1
  httpPort: 8546
  service:
    type: ClusterIP
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  # BP info from sqlit-0 (must match leader identity in clusterNodes)
  # These are the ACTUAL keys extracted from sqlit-0 pod
  bpNodeId: "00000024e0ddd9ed2136def8dfc981dd9471de3ad987732bd43ca61ecec54db9"
  bpPublicKey: "02aa56b3bac77b891d181367f73392fdf7db819dc37473abce17ce88a23a31d120"
  bpNonceA: "1856657"
  bpNonceB: "0"
  bpNonceC: "0"
  bpNonceD: "1736386126"
