# SQLIT (SQLIT) Multi-Node Cluster for Local Development
#
# This starts a SQLIT cluster with:
# - 1 Block Producer (consensus coordinator)
# - 3 Miner nodes (data storage & replication)
# - Load balancer for client connections
#
# Usage:
#   docker compose -f sqlit-cluster.compose.yaml up -d
#
# Connect via:
#   http://localhost:4661 (load balanced to miners)
#   http://localhost:8546 (HTTP API)

services:
  # ============================================================================
  # Block Producer - Coordinates consensus and block production
  # ============================================================================
  sqlit-bp:
    build:
      context: ./sqlit
      dockerfile: Dockerfile
    container_name: sqlit-block-producer
    hostname: sqlit-bp
    command:
      - -config
      - /config/bp.yaml
    ports:
      - "4660:4661"  # Different port to avoid conflict with LB
      - "8546:8546"  # HTTP API
      - "9100:9100"  # Metrics
    volumes:
      - ./sqlit/config/bp.yaml:/config/bp.yaml:ro
      - sqlit-bp-data:/data
      - sqlit-bp-logs:/logs
    environment:
      - SQLIT_NODE_ID=bp-001
      - SQLIT_ROLE=blockproducer
      - SQLIT_LOG_LEVEL=info
    networks:
      sqlit-network:
        aliases:
          - sqlit-bp
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8546/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ============================================================================
  # Miner Node 1
  # ============================================================================
  sqlit-miner-1:
    build:
      context: ./sqlit
      dockerfile: Dockerfile
    container_name: sqlit-miner-1
    hostname: sqlit-miner-1
    entrypoint: ["sqlit-minerd"]
    command:
      - -config
      - /config/miner.yaml
    depends_on:
      sqlit-bp:
        condition: service_healthy
    volumes:
      - ./sqlit/config/miner.yaml:/config/miner.yaml:ro
      - sqlit-miner-1-data:/data
      - sqlit-miner-1-logs:/logs
    environment:
      - SQLIT_NODE_ID=miner-001
      - SQLIT_ROLE=miner
      - SQLIT_BP_ADDR=sqlit-bp:4661
      - SQLIT_LOG_LEVEL=info
    networks:
      - sqlit-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8546/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ============================================================================
  # Miner Node 2
  # ============================================================================
  sqlit-miner-2:
    build:
      context: ./sqlit
      dockerfile: Dockerfile
    container_name: sqlit-miner-2
    hostname: sqlit-miner-2
    entrypoint: ["sqlit-minerd"]
    command:
      - -config
      - /config/miner.yaml
    depends_on:
      sqlit-bp:
        condition: service_healthy
    volumes:
      - ./sqlit/config/miner.yaml:/config/miner.yaml:ro
      - sqlit-miner-2-data:/data
      - sqlit-miner-2-logs:/logs
    environment:
      - SQLIT_NODE_ID=miner-002
      - SQLIT_ROLE=miner
      - SQLIT_BP_ADDR=sqlit-bp:4661
      - SQLIT_LOG_LEVEL=info
    networks:
      - sqlit-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8546/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ============================================================================
  # Miner Node 3
  # ============================================================================
  sqlit-miner-3:
    build:
      context: ./sqlit
      dockerfile: Dockerfile
    container_name: sqlit-miner-3
    hostname: sqlit-miner-3
    entrypoint: ["sqlit-minerd"]
    command:
      - -config
      - /config/miner.yaml
    depends_on:
      sqlit-bp:
        condition: service_healthy
    volumes:
      - ./sqlit/config/miner.yaml:/config/miner.yaml:ro
      - sqlit-miner-3-data:/data
      - sqlit-miner-3-logs:/logs
    environment:
      - SQLIT_NODE_ID=miner-003
      - SQLIT_ROLE=miner
      - SQLIT_BP_ADDR=sqlit-bp:4661
      - SQLIT_LOG_LEVEL=info
    networks:
      - sqlit-network
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8546/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ============================================================================
  # HAProxy Load Balancer - Distributes client connections
  # ============================================================================
  sqlit-lb:
    image: haproxy:2.9-alpine
    container_name: sqlit-load-balancer
    hostname: sqlit-lb
    ports:
      - "4661:4661"  # Client connections
      - "8547:8080"  # Stats UI
    volumes:
      - ./sqlit/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - sqlit-miner-1
      - sqlit-miner-2
      - sqlit-miner-3
    networks:
      - sqlit-network
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # Prometheus - Metrics collection
  # ============================================================================
  sqlit-prometheus:
    image: prom/prometheus:v2.48.0
    container_name: sqlit-prometheus
    hostname: sqlit-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./sqlit/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - sqlit-prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - sqlit-network
    profiles:
      - monitoring
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  sqlit-network:
    driver: bridge
    name: sqlit-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  sqlit-bp-data:
  sqlit-bp-logs:
  sqlit-miner-1-data:
  sqlit-miner-1-logs:
  sqlit-miner-2-data:
  sqlit-miner-2-logs:
  sqlit-miner-3-data:
  sqlit-miner-3-logs:
  sqlit-prometheus-data:

