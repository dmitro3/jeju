# Phala CVM OAuth3 Auth Agent Deployment
#
# Phala Network provides TEE (Trusted Execution Environment) via
# Secure Enclaves without requiring specialized hardware like Intel TDX.
#
# For testnet deployment (Phala Testnet):
#   docker compose -f phala.compose.yaml --profile testnet up
#
# For mainnet/production (Phala Mainnet):
#   docker compose -f phala.compose.yaml --profile mainnet up

x-oauth-env: &oauth-env
  OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID}
  OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET}
  OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID}
  OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET}
  OAUTH_TWITTER_CLIENT_ID: ${OAUTH_TWITTER_CLIENT_ID}
  OAUTH_TWITTER_CLIENT_SECRET: ${OAUTH_TWITTER_CLIENT_SECRET}
  OAUTH_DISCORD_CLIENT_ID: ${OAUTH_DISCORD_CLIENT_ID}
  OAUTH_DISCORD_CLIENT_SECRET: ${OAUTH_DISCORD_CLIENT_SECRET}
  NEYNAR_API_KEY: ${NEYNAR_API_KEY}
  FARCASTER_HUB_URL: ${FARCASTER_HUB_URL:-https://hub.pinata.cloud}

x-phala-base: &phala-base
  image: ghcr.io/jeju-network/oauth3-agent:latest
  networks:
    - oauth3-phala-network

x-testnet-resources: &testnet-resources
  deploy:
    resources:
      limits:
        memory: 2G
        cpus: "1"
      reservations:
        memory: 1G
        cpus: "0.5"

x-mainnet-resources: &mainnet-resources
  deploy:
    replicas: 1
    resources:
      limits:
        memory: 4G
        cpus: "2"
      reservations:
        memory: 2G
        cpus: "1"

x-healthcheck: &healthcheck
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:${OAUTH3_PORT:-4200}/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s

x-testnet-env: &testnet-env
  OAUTH3_CLUSTER_ID: oauth3-phala-cluster
  JEJU_RPC_URL: ${JEJU_TESTNET_RPC_URL:-https://testnet.jejunetwork.org}
  CHAIN_ID: "420690"
  TEE_MODE: phala
  PHALA_CLUSTER_ID: ${PHALA_CLUSTER_ID}
  DWS_URL: ${DWS_URL:-https://dws.testnet.jejunetwork.org}
  IPFS_API_ENDPOINT: ${IPFS_API_ENDPOINT:-https://dws.testnet.jejunetwork.org/storage/api/v0}
  IPFS_GATEWAY_ENDPOINT: ${IPFS_GATEWAY_ENDPOINT:-https://dws.testnet.jejunetwork.org/storage/ipfs}
  JNS_GATEWAY: ${JNS_GATEWAY:-https://jns.testnet.jejunetwork.org}
  LOG_LEVEL: info
  MPC_ENABLED: "true"
  MPC_THRESHOLD: "2"
  MPC_TOTAL_PARTIES: "3"
  OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID}
  OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET}
  OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID}
  OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET}
  OAUTH_TWITTER_CLIENT_ID: ${OAUTH_TWITTER_CLIENT_ID}
  OAUTH_TWITTER_CLIENT_SECRET: ${OAUTH_TWITTER_CLIENT_SECRET}
  OAUTH_DISCORD_CLIENT_ID: ${OAUTH_DISCORD_CLIENT_ID}
  OAUTH_DISCORD_CLIENT_SECRET: ${OAUTH_DISCORD_CLIENT_SECRET}
  NEYNAR_API_KEY: ${NEYNAR_API_KEY}
  FARCASTER_HUB_URL: ${FARCASTER_HUB_URL:-https://hub.pinata.cloud}

x-mainnet-env: &mainnet-env
  OAUTH3_CLUSTER_ID: oauth3-mainnet-cluster
  JEJU_RPC_URL: ${JEJU_MAINNET_RPC_URL:-https://mainnet.jejunetwork.org}
  CHAIN_ID: "420692"
  TEE_MODE: phala
  PHALA_CLUSTER_ID: ${PHALA_MAINNET_CLUSTER_ID}
  DWS_URL: ${DWS_MAINNET_URL:-https://dws.jejunetwork.org}
  IPFS_API_ENDPOINT: ${IPFS_MAINNET_ENDPOINT:-https://dws.jejunetwork.org/storage/api/v0}
  IPFS_GATEWAY_ENDPOINT: ${IPFS_MAINNET_GATEWAY:-https://dws.jejunetwork.org/storage/ipfs}
  JNS_GATEWAY: ${JNS_MAINNET_GATEWAY:-https://jns.jejunetwork.org}
  LOG_LEVEL: warn
  MPC_ENABLED: "true"
  MPC_THRESHOLD: "2"
  MPC_TOTAL_PARTIES: "3"
  OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID}
  OAUTH_GOOGLE_CLIENT_SECRET: ${OAUTH_GOOGLE_CLIENT_SECRET}
  OAUTH_GITHUB_CLIENT_ID: ${OAUTH_GITHUB_CLIENT_ID}
  OAUTH_GITHUB_CLIENT_SECRET: ${OAUTH_GITHUB_CLIENT_SECRET}
  OAUTH_TWITTER_CLIENT_ID: ${OAUTH_TWITTER_CLIENT_ID}
  OAUTH_TWITTER_CLIENT_SECRET: ${OAUTH_TWITTER_CLIENT_SECRET}
  OAUTH_DISCORD_CLIENT_ID: ${OAUTH_DISCORD_CLIENT_ID}
  OAUTH_DISCORD_CLIENT_SECRET: ${OAUTH_DISCORD_CLIENT_SECRET}
  NEYNAR_API_KEY: ${NEYNAR_API_KEY}
  FARCASTER_HUB_URL: ${FARCASTER_HUB_URL:-https://hub.pinata.cloud}

services:
  # Testnet Deployment
  oauth3-phala-1:
    <<: [*phala-base, *testnet-resources, *healthcheck]
    profiles: [testnet]
    environment:
      <<: *testnet-env
      OAUTH3_NODE_ID: oauth3-phala-1
      OAUTH3_PORT: "4200"
      MPC_ENDPOINT: http://oauth3-phala-2:4100
      PHALA_WORKER_PUBKEY: ${PHALA_WORKER_PUBKEY_1}
    volumes:
      - oauth3-phala-data-1:/data
    ports:
      - "4200:4200"

  oauth3-phala-2:
    <<: [*phala-base, *testnet-resources, *healthcheck]
    profiles: [testnet]
    environment:
      <<: *testnet-env
      OAUTH3_NODE_ID: oauth3-phala-2
      OAUTH3_PORT: "4201"
      MPC_ENDPOINT: http://oauth3-phala-1:4100
      PHALA_WORKER_PUBKEY: ${PHALA_WORKER_PUBKEY_2}
    volumes:
      - oauth3-phala-data-2:/data
    ports:
      - "4201:4201"

  oauth3-phala-3:
    <<: [*phala-base, *testnet-resources, *healthcheck]
    profiles: [testnet]
    environment:
      <<: *testnet-env
      OAUTH3_NODE_ID: oauth3-phala-3
      OAUTH3_PORT: "4202"
      MPC_ENDPOINT: http://oauth3-phala-1:4100
      PHALA_WORKER_PUBKEY: ${PHALA_WORKER_PUBKEY_3}
    volumes:
      - oauth3-phala-data-3:/data
    ports:
      - "4202:4202"

  # Mainnet/Production Deployment
  oauth3-phala-prod-1:
    <<: [*phala-base, *mainnet-resources]
    profiles: [mainnet]
    environment:
      <<: *mainnet-env
      OAUTH3_NODE_ID: oauth3-mainnet-1
      OAUTH3_PORT: "4200"
      MPC_ENDPOINT: http://oauth3-phala-prod-2:4100
      PHALA_WORKER_PUBKEY: ${PHALA_MAINNET_WORKER_PUBKEY_1}
    volumes:
      - oauth3-phala-prod-data-1:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4200/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  oauth3-phala-prod-2:
    <<: [*phala-base, *mainnet-resources]
    profiles: [mainnet]
    environment:
      <<: *mainnet-env
      OAUTH3_NODE_ID: oauth3-mainnet-2
      OAUTH3_PORT: "4201"
      MPC_ENDPOINT: http://oauth3-phala-prod-1:4100
      PHALA_WORKER_PUBKEY: ${PHALA_MAINNET_WORKER_PUBKEY_2}
    volumes:
      - oauth3-phala-prod-data-2:/data

  oauth3-phala-prod-3:
    <<: [*phala-base, *mainnet-resources]
    profiles: [mainnet]
    environment:
      <<: *mainnet-env
      OAUTH3_NODE_ID: oauth3-mainnet-3
      OAUTH3_PORT: "4202"
      MPC_ENDPOINT: http://oauth3-phala-prod-1:4100
      PHALA_WORKER_PUBKEY: ${PHALA_MAINNET_WORKER_PUBKEY_3}
    volumes:
      - oauth3-phala-prod-data-3:/data

  # Load balancer for Phala cluster
  oauth3-phala-lb:
    image: nginx:1.27-alpine
    profiles: [testnet, mainnet]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "4210:80"
    networks:
      - oauth3-phala-network
    depends_on:
      - oauth3-phala-1
      - oauth3-phala-2
      - oauth3-phala-3

networks:
  oauth3-phala-network:
    driver: bridge

volumes:
  oauth3-phala-data-1:
  oauth3-phala-data-2:
  oauth3-phala-data-3:
  oauth3-phala-prod-data-1:
  oauth3-phala-prod-data-2:
  oauth3-phala-prod-data-3:
