# Jeju Infrastructure Stack
#
# Docker services for local development (excludes CQL which runs natively):
# - IPFS: Decentralized storage
# - JNS Gateway: Name resolution and frontend serving
# - PostgreSQL: For Indexer (Subsquid requirement only)
#
# NOTE: Cache and DA services are now provided by DWS at /cache and /da endpoints
#
# CQL (CovenantSQL) runs NATIVELY via the CLI for faster dev:
#   jeju dev  # Starts CQL + these Docker services + localnet
#
# For production-like testing with Docker-based CQL:
#   docker compose --profile production up
#
# Usage (standalone Docker services only):
#   docker compose up -d

services:
  # ============================================================================
  # IPFS - Decentralized Storage
  # ============================================================================
  ipfs:
    image: ipfs/kubo:v0.32.1
    container_name: jeju-ipfs
    hostname: ipfs
    ports:
      - "4001:4001"     # Swarm
      - "4001:4001/udp" # Swarm UDP
      - "5001:5001"     # API
      - "4180:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    networks:
      - jeju
    healthcheck:
      test: ["CMD-SHELL", "ipfs dag stat /ipfs/QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # PostgreSQL - ONLY for Indexer (Subsquid requires it)
  # All other apps should use CovenantSQL
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: jeju-postgres
    hostname: postgres
    ports:
      - "5434:5432"  # Use 5434 to avoid conflicts with local postgres
    environment:
      - POSTGRES_USER=jeju
      # LOCALNET ONLY: Use env var or default. NEVER use defaults in production
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-localnet_dev_only}
      - POSTGRES_DB=jeju
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - jeju
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jeju -d jeju"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # CQL - Docker-based CovenantSQL (for production-like testing)
  # NOTE: For normal dev, CQL runs NATIVELY via `jeju dev` for faster startup
  # Use this with: docker compose --profile production up
  # ============================================================================
  cql:
    build:
      context: ./covenantsql
      dockerfile: Dockerfile
    container_name: jeju-cql-docker
    hostname: cql
    profiles:
      - production
    ports:
      - "4661:4661"   # Client connections
      - "4662:4662"   # Node-to-node
      - "8546:8546"   # HTTP API
    environment:
      - CQL_ROLE=bp
      - CQL_NODE_ID=00000000000000000000000000000001
      - CQL_DATA_DIR=/data
      - CQL_LOG_LEVEL=info
    volumes:
      - cql-bp-data:/data
      - ./covenantsql/config/bp.yaml:/config/config.yaml:ro
    networks:
      - jeju
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8546/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  cql-miner:
    build:
      context: ./covenantsql
      dockerfile: Dockerfile
    container_name: jeju-cql-miner
    hostname: cql-miner
    profiles:
      - production
    environment:
      - CQL_ROLE=miner
      - CQL_BP_ADDR=cql:4661
      - CQL_DATA_DIR=/data
      - CQL_LOG_LEVEL=info
    volumes:
      - cql-miner-data:/data
      - ./covenantsql/config/miner.yaml:/config/config.yaml:ro
    networks:
      - jeju
    depends_on:
      cql:
        condition: service_healthy
    restart: unless-stopped

  # ============================================================================
  # JNS Gateway - Frontend Serving via JNS
  # ============================================================================
  jns-gateway:
    build:
      context: ../../../apps/gateway
      dockerfile: Dockerfile.jns
    container_name: jeju-jns-gateway
    hostname: jns-gateway
    ports:
      - "4005:4005"
    environment:
      - JNS_GATEWAY_PORT=4005
      - JEJU_RPC_URL=${JEJU_RPC_URL:-http://host.docker.internal:6546}
      - JNS_REGISTRY_ADDRESS=${JNS_REGISTRY_ADDRESS:-0x0000000000000000000000000000000000000000}
      - JNS_RESOLVER_ADDRESS=${JNS_RESOLVER_ADDRESS:-0x0000000000000000000000000000000000000000}
      - IPFS_GATEWAY_URL=http://ipfs:8080
      # Cache is provided by DWS at /cache endpoint
      - CACHE_SERVICE_URL=http://host.docker.internal:4030/cache
    depends_on:
      ipfs:
        condition: service_healthy
    networks:
      - jeju
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # Compute Trigger Service
  # ============================================================================
  trigger-service:
    build:
      context: ../../../apps/dws
      dockerfile: docker/Dockerfile.trigger
    container_name: jeju-triggers
    hostname: triggers
    ports:
      - "4016:4016"
    environment:
      - TRIGGER_PORT=4016
      - JEJU_RPC_URL=${JEJU_RPC_URL:-http://host.docker.internal:6546}
      - TRIGGER_REGISTRY_ADDRESS=${TRIGGER_REGISTRY_ADDRESS:-0x0000000000000000000000000000000000000000}
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - POLL_INTERVAL_MS=60000
      - MAX_CONCURRENT_EXECUTIONS=10
    networks:
      - jeju
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4016/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # ERC-4337 Bundler - Gasless Transactions
  # ============================================================================
  bundler:
    image: ghcr.io/pimlicolabs/alto:v0.14.0
    container_name: jeju-bundler
    profiles:
      - full
    ports:
      - "4337:4337"
    environment:
      - ALTO_RPC_URL=${JEJU_RPC_URL:-http://host.docker.internal:6546}
      - ALTO_CHAIN_ID=${CHAIN_ID:-420691}
      - ALTO_ENTRYPOINT=0x0000000071727De22E5E9d8BAf0edAc6f37da032
      # SECURITY: Private key required - set BUNDLER_PRIVATE_KEY env var
      # For localnet only, you can use Anvil account #1
      # LOCALNET: Use Anvil account #1 by default for local development
      - ALTO_PRIVATE_KEY=${BUNDLER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
      - ALTO_PORT=4337
      - ALTO_LOG_LEVEL=${LOG_LEVEL:-info}
      - ALTO_MAX_BUNDLE_SIZE=10
      - ALTO_BUNDLE_INTERVAL_MS=100
    networks:
      - jeju
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4337/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Farcaster Hub - Permissionless Farcaster Hub Node
  # ============================================================================
  farcaster-hub:
    image: farcasterxyz/hubble:1.14.0
    container_name: jeju-farcaster-hub
    hostname: farcaster-hub
    ports:
      - "2281:2281"  # HTTP API
      - "2282:2282"  # Gossip
      - "2283:2283"  # gRPC
    command:
      - node
      - build/cli.js
      - start
      - --eth-mainnet-rpc-url=${ETH_RPC_URL:-https://mainnet.optimism.io}
      - --l2-rpc-url=${ETH_RPC_URL:-https://mainnet.optimism.io}
      - --rpc-port=2283
      - --gossip-port=2282
      - --http-api-port=2281
      - --http-api-enabled
      - --db-name=/data/rocks
      - --bootstrap=/dns/nemes.farcaster.xyz/tcp/2282
      - --bootstrap=/dns/hoyt.farcaster.xyz/tcp/2282
    environment:
      - HUB_HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - farcaster-hub-data:/data
      - farcaster-hub-identity:/identity
    networks:
      - jeju
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2281/v1/info"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

networks:
  jeju:
    name: jeju
    driver: bridge

volumes:
  ipfs-data:
  postgres-data:
  cql-bp-data:      # Docker-based CQL (production profile)
  cql-miner-data:   # Docker-based CQL miner (production profile)
  farcaster-hub-data:
  farcaster-hub-identity: