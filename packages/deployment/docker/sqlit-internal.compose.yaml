# Internal SQLIT (SQLIT) Cluster for Jeju Local Development
#
# This starts a SQLIT cluster using the internal packages/sqlit implementation:
# - 3 Block Producers (BFT-Raft consensus)
# - 3 Miners (data storage)
# - 1 Adapter (HTTP API)
#
# Usage:
#   docker compose -f sqlit-internal.compose.yaml up -d
#
# Connect via:
#   http://localhost:4661 (adapter API)
#
# Build from source:
#   docker compose -f sqlit-internal.compose.yaml build

services:
  # ============================================================================
  # SQLIT Builder - Builds binaries from packages/sqlit
  # ============================================================================
  sqlit-builder:
    build:
      context: ../../sqlit
      dockerfile: ../deployment/docker/sqlit-internal.Dockerfile
      target: builder
    image: jeju-sqlit-builder:latest

  # ============================================================================
  # Block Producer 0 (Bootstrap)
  # ============================================================================
  sqlit-bp-0:
    build:
      context: ../../sqlit
      dockerfile: ../deployment/docker/sqlit-internal.Dockerfile
    image: jeju-sqlit:latest
    container_name: sqlit-bp-0
    hostname: sqlit-bp-0
    environment:
      SQLIT_ROLE: blockproducer
      SQLIT_CONF: /config/bp-0.yaml
      SQLIT_NODE_ID: bp-0
      SQLIT_BOOTSTRAP: "true"
    ports:
      - "4660:4661"  # Different port to avoid conflict
      - "8546:8546"  # HTTP API
    volumes:
      - ./sqlit-config:/config
      - sqlit-bp-0-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.2
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  # ============================================================================
  # Block Producer 1
  # ============================================================================
  sqlit-bp-1:
    image: jeju-sqlit:latest
    container_name: sqlit-bp-1
    hostname: sqlit-bp-1
    depends_on:
      sqlit-bp-0:
        condition: service_healthy
    environment:
      SQLIT_ROLE: blockproducer
      SQLIT_CONF: /config/bp-1.yaml
      SQLIT_NODE_ID: bp-1
    volumes:
      - ./sqlit-config:/config
      - sqlit-bp-1-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.3
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Block Producer 2
  # ============================================================================
  sqlit-bp-2:
    image: jeju-sqlit:latest
    container_name: sqlit-bp-2
    hostname: sqlit-bp-2
    depends_on:
      sqlit-bp-0:
        condition: service_healthy
    environment:
      SQLIT_ROLE: blockproducer
      SQLIT_CONF: /config/bp-2.yaml
      SQLIT_NODE_ID: bp-2
    volumes:
      - ./sqlit-config:/config
      - sqlit-bp-2-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.4
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Miner 0
  # ============================================================================
  sqlit-miner-0:
    image: jeju-sqlit:latest
    container_name: sqlit-miner-0
    hostname: sqlit-miner-0
    depends_on:
      sqlit-bp-0:
        condition: service_healthy
      sqlit-bp-1:
        condition: service_healthy
      sqlit-bp-2:
        condition: service_healthy
    environment:
      SQLIT_ROLE: miner
      SQLIT_CONF: /config/miner-0.yaml
      SQLIT_NODE_ID: miner-0
    volumes:
      - ./sqlit-config:/config
      - sqlit-miner-0-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.5
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Miner 1
  # ============================================================================
  sqlit-miner-1:
    image: jeju-sqlit:latest
    container_name: sqlit-miner-1
    hostname: sqlit-miner-1
    depends_on:
      sqlit-bp-0:
        condition: service_healthy
    environment:
      SQLIT_ROLE: miner
      SQLIT_CONF: /config/miner-1.yaml
      SQLIT_NODE_ID: miner-1
    volumes:
      - ./sqlit-config:/config
      - sqlit-miner-1-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.6
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # Miner 2
  # ============================================================================
  sqlit-miner-2:
    image: jeju-sqlit:latest
    container_name: sqlit-miner-2
    hostname: sqlit-miner-2
    depends_on:
      sqlit-bp-0:
        condition: service_healthy
    environment:
      SQLIT_ROLE: miner
      SQLIT_CONF: /config/miner-2.yaml
      SQLIT_NODE_ID: miner-2
    volumes:
      - ./sqlit-config:/config
      - sqlit-miner-2-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.7
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================================================
  # HTTP Adapter (Client API)
  # ============================================================================
  sqlit-adapter:
    image: jeju-sqlit:latest
    container_name: sqlit-adapter
    hostname: sqlit-adapter
    depends_on:
      sqlit-miner-0:
        condition: service_healthy
      sqlit-miner-1:
        condition: service_healthy
      sqlit-miner-2:
        condition: service_healthy
    environment:
      SQLIT_ROLE: adapter
      SQLIT_CONF: /config/adapter.yaml
      SQLIT_ADAPTER_ADDR: "0.0.0.0:4661"
    ports:
      - "4661:4661"  # HTTP API
    volumes:
      - ./sqlit-config:/config
      - sqlit-adapter-data:/data
    networks:
      sqlit-internal:
        ipv4_address: 172.29.0.10
    healthcheck:
      test: ["CMD", "sh", "-c", "echo -n | nc -w1 localhost 4661"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  sqlit-internal:
    driver: bridge
    name: sqlit-internal
    ipam:
      config:
        - subnet: 172.29.0.0/24

# ============================================================================
# Volumes
# ============================================================================
volumes:
  sqlit-bp-0-data:
  sqlit-bp-1-data:
  sqlit-bp-2-data:
  sqlit-miner-0-data:
  sqlit-miner-1-data:
  sqlit-miner-2-data:
  sqlit-adapter-data:



