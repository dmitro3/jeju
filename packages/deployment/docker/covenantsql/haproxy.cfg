# HAProxy Configuration for CQL Cluster
# Load balances client connections across miner nodes

global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    option  redispatch
    retries 3
    timeout connect 10s
    timeout client  60s
    timeout server  60s
    timeout check   5s

# Stats UI
frontend stats
    mode http
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# CQL Client Connections (TCP)
frontend cql_clients
    bind *:4661
    default_backend cql_miners

backend cql_miners
    balance roundrobin
    option tcp-check
    tcp-check connect port 8546
    tcp-check send GET\ /v1/health\ HTTP/1.1\r\nHost:\ localhost\r\n\r\n
    tcp-check expect string ok

    server miner1 cql-miner-1:4661 check inter 5s rise 2 fall 3
    server miner2 cql-miner-2:4661 check inter 5s rise 2 fall 3
    server miner3 cql-miner-3:4661 check inter 5s rise 2 fall 3

# HTTP API (for queries)
frontend cql_http
    mode http
    bind *:8546
    default_backend cql_http_servers

backend cql_http_servers
    mode http
    balance roundrobin
    option httpchk GET /v1/health
    http-check expect status 200

    server miner1 cql-miner-1:8546 check inter 5s rise 2 fall 3
    server miner2 cql-miner-2:8546 check inter 5s rise 2 fall 3
    server miner3 cql-miner-3:8546 check inter 5s rise 2 fall 3
